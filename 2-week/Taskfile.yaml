version: "3"

vars:
  PROTO_DIR: proto
  GEN_GO_DIR: gen/go

tasks:
  check-os:
    silent: true
    cmds:
      - |
        {{if eq OS "windows"}}
          echo "ü™ü Windows detected? üêß sudo switch-to-linux --now!"
        {{end}}

  install-deps:
    desc: üõ†Ô∏è Install protobuf toolchain (protoc + Go plugins)
    deps: [check-os]
    silent: true
    cmds:
      - echo "üì¶ Checking dependencies..."
      - |
        if ! command -v protoc >/dev/null 2>&1;
        then
          echo "‚ùå Error: protoc not found."
          echo "üëâ Install it with one of:"
          echo "   Arch:          sudo pacman -S protobuf"
          echo "   Ubuntu/Debian: sudo apt-get update && sudo apt-get install -y protobuf-compiler"
          echo "   macOS (brew):  brew install protobuf"
          exit 1
        fi
      - echo "‚úÖ protoc found"
      - echo "‚¨áÔ∏è  Installing Go plugins (protoc-gen-go, protoc-gen-go-grpc)..."
      - go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
      - go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
      - echo "üéâ All dependencies installed!"

  generate:
    desc: üöÄ Generate Go protobuf/grpc stubs for all .proto files
    deps: [install-deps]
    sources:
      - proto/**/*.proto
    generates:
      - gen/go/**/*.go
    silent: true
    cmds:
      - echo "üî® Generating Go code from protos..."
      - mkdir -p "{{.GEN_GO_DIR}}"
      - |
        export PATH="$(go env GOPATH)/bin:$PATH"
        PROTO_FILES="$(find "{{.PROTO_DIR}}" -type f -name '*.proto' -print)"

        if [ -z "$PROTO_FILES" ]; then
          echo "‚ö†Ô∏è  No .proto files found under '{{.PROTO_DIR}}'"
          exit 1
        fi

        protoc \
          -I "{{.PROTO_DIR}}" \
          --go_out="{{.GEN_GO_DIR}}" --go_opt=paths=source_relative \
          --go-grpc_out="{{.GEN_GO_DIR}}" --go-grpc_opt=paths=source_relative \
          $PROTO_FILES
      - echo "‚ú® Generation complete!"

  run-chat:
    desc: üí¨ Run Chat Service
    cmds:
      - go run ./cmd/chat/main.go

  run-user:
    desc: üë§ Run User Service
    cmds:
      - go run ./cmd/user/main.go

  dev:
    desc: üèÉ Run both services in parallel
    deps: [run-chat, run-user]